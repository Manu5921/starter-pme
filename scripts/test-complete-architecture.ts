#!/usr/bin/env tsx

import { ClientGenerator } from "../lib/generators/client-generator";
import { duboisPlomberieConfig } from "../lib/configs/examples/dubois-plomberie";

// Configuration de test compl√®te
const testClient = {
  businessName: "Plomberie Test Lyon",
  contactName: "Jean Test",
  email: "test@plomberie-test-lyon.fr",
  phone: "06 11 22 33 44",
  templateType: "plumber" as const,
  address: {
    street: "123 rue de Test",
    city: "Lyon",
    postalCode: "69001",
    country: "France"
  },
  customizations: {
    headline: "Votre Plombier Test √† Lyon",
    subheadline: "Test d'intervention rapide 24h/24",
    openingHours: {
      monday: "8h-19h",
      tuesday: "8h-19h",
      wednesday: "8h-19h",
      thursday: "8h-19h",
      friday: "8h-19h",
      saturday: "9h-17h",
      sunday: "Urgences test",
      emergency: "Test 24h/24"
    }
  }
};

interface TestResult {
  name: string;
  success: boolean;
  duration: number;
  details?: any;
  error?: string;
}

class ArchitectureTestSuite {
  private results: TestResult[] = [];

  private async runTest(name: string, testFn: () => Promise<any>): Promise<TestResult> {
    const startTime = Date.now();
    console.log(`üß™ Test: ${name}...`);

    try {
      const result = await testFn();
      const duration = Date.now() - startTime;
      
      console.log(`‚úÖ ${name} - ${duration}ms`);
      
      const testResult: TestResult = {
        name,
        success: true,
        duration,
        details: result
      };
      
      this.results.push(testResult);
      return testResult;
      
    } catch (error) {
      const duration = Date.now() - startTime;
      console.log(`‚ùå ${name} - ${duration}ms`);
      console.log(`   Erreur: ${error instanceof Error ? error.message : 'Erreur inconnue'}`);
      
      const testResult: TestResult = {
        name,
        success: false,
        duration,
        error: error instanceof Error ? error.message : 'Erreur inconnue'
      };
      
      this.results.push(testResult);
      return testResult;
    }
  }

  async testConfigGeneration() {
    return this.runTest("G√©n√©ration de configuration", async () => {
      const config = await ClientGenerator.generateClientConfig(testClient);
      
      // V√©rifications de base
      if (!config.id) throw new Error("ID manquant");
      if (!config.domain) throw new Error("Domaine manquant");
      if (!config.business.name) throw new Error("Nom d'entreprise manquant");
      if (!config.seo.title) throw new Error("Titre SEO manquant");
      if (!config.content.services || config.content.services.length === 0) {
        throw new Error("Services manquants");
      }
      
      return {
        id: config.id,
        domain: config.domain,
        template: config.template,
        servicesCount: config.content.services.length,
        seoKeywords: config.seo.keywords.length
      };
    });
  }

  async testFileGeneration() {
    return this.runTest("G√©n√©ration des fichiers", async () => {
      const config = await ClientGenerator.generateClientConfig(testClient);
      const files = (ClientGenerator as any).generateSiteFiles(config);
      
      const requiredFiles = [
        'package.json',
        'next.config.js',
        'app/page.tsx',
        'app/layout.tsx',
        'app/globals.css',
        'tailwind.config.js',
        'lib/config.ts'
      ];
      
      const missingFiles = requiredFiles.filter(file => !files[file]);
      if (missingFiles.length > 0) {
        throw new Error(`Fichiers manquants: ${missingFiles.join(', ')}`);
      }
      
      // V√©rifier la validit√© du package.json
      try {
        const packageJson = JSON.parse(files['package.json']);
        if (!packageJson.dependencies || !packageJson.scripts) {
          throw new Error("package.json invalide");
        }
      } catch (e) {
        throw new Error("package.json mal form√©");
      }
      
      return {
        filesGenerated: Object.keys(files).length,
        totalSize: Math.round(Object.values(files).join('').length / 1024) + 'KB',
        files: Object.keys(files)
      };
    });
  }

  async testTemplateRendering() {
    return this.runTest("Rendu du template", async () => {
      // Test avec la configuration d'exemple
      const config = duboisPlomberieConfig;
      
      // V√©rifier que toutes les sections ont du contenu
      if (!config.content.hero.headline) throw new Error("Hero headline manquant");
      if (!config.content.services || config.content.services.length === 0) {
        throw new Error("Services manquants");
      }
      if (!config.content.testimonials || config.content.testimonials.length === 0) {
        throw new Error("T√©moignages manquants");
      }
      if (!config.content.faq || config.content.faq.length === 0) {
        throw new Error("FAQ manquante");
      }
      
      return {
        template: config.template,
        heroHeadline: config.content.hero.headline,
        servicesCount: config.content.services.length,
        testimonialsCount: config.content.testimonials.length,
        faqCount: config.content.faq.length,
        seoOptimized: config.seo.keywords.length > 5
      };
    });
  }

  async testDatabaseSchema() {
    return this.runTest("Validation du sch√©ma de base", async () => {
      // Test de validation des types TypeScript
      const config = await ClientGenerator.generateClientConfig(testClient);
      
      // V√©rifier que la config peut √™tre s√©rialis√©e/d√©s√©rialis√©e
      const serialized = JSON.stringify(config);
      const deserialized = JSON.parse(serialized);
      
      if (!deserialized.business || !deserialized.seo || !deserialized.content) {
        throw new Error("Structure de configuration invalide");
      }
      
      return {
        configSize: Math.round(serialized.length / 1024) + 'KB',
        structure: {
          business: !!deserialized.business,
          seo: !!deserialized.seo,
          content: !!deserialized.content,
          theme: !!deserialized.theme
        }
      };
    });
  }

  async testSEOGeneration() {
    return this.runTest("G√©n√©ration SEO", async () => {
      const config = await ClientGenerator.generateClientConfig(testClient);
      const seo = config.seo;
      
      // V√©rifications SEO
      if (!seo.title || seo.title.length < 30) {
        throw new Error("Titre SEO trop court");
      }
      if (!seo.description || seo.description.length < 120) {
        throw new Error("Description SEO trop courte");
      }
      if (!seo.keywords || seo.keywords.length < 5) {
        throw new Error("Pas assez de mots-cl√©s");
      }
      
      // V√©rifier que la ville est pr√©sente dans le titre
      if (!seo.title.toLowerCase().includes(testClient.address.city.toLowerCase())) {
        throw new Error("Ville manquante dans le titre SEO");
      }
      
      return {
        titleLength: seo.title.length,
        descriptionLength: seo.description.length,
        keywordsCount: seo.keywords.length,
        localOptimized: seo.title.includes(testClient.address.city)
      };
    });
  }

  async testResponsiveComponents() {
    return this.runTest("Composants responsive", async () => {
      const config = await ClientGenerator.generateClientConfig(testClient);
      
      // V√©rifier que les composants ont les bonnes classes Tailwind
      const files = (ClientGenerator as any).generateSiteFiles(config);
      const mainPage = files['app/page.tsx'];
      
      // V√©rifier la pr√©sence de classes responsive
      const responsiveClasses = [
        'md:', 'lg:', 'sm:', 'xl:',
        'grid-cols-1', 'grid-cols-2', 'grid-cols-3',
        'flex-col', 'flex-row'
      ];
      
      const foundClasses = responsiveClasses.filter(cls => mainPage.includes(cls));
      
      if (foundClasses.length < 3) {
        throw new Error("Pas assez de classes responsive d√©tect√©es");
      }
      
      return {
        responsiveClassesFound: foundClasses.length,
        classes: foundClasses.slice(0, 5),
        mobileFirst: mainPage.includes('grid-cols-1')
      };
    });
  }

  async testPerformanceOptimization() {
    return this.runTest("Optimisations performance", async () => {
      const config = await ClientGenerator.generateClientConfig(testClient);
      const files = (ClientGenerator as any).generateSiteFiles(config);
      
      // V√©rifier les optimisations Next.js
      const nextConfig = files['next.config.js'];
      const packageJson = JSON.parse(files['package.json']);
      
      // V√©rifications d'optimisation
      const checks = {
        standalone: nextConfig.includes('standalone'),
        framerMotion: !!packageJson.dependencies['framer-motion'],
        tailwind: !!packageJson.dependencies['tailwindcss'],
        lucideIcons: !!packageJson.dependencies['lucide-react'],
        nextOptimized: nextConfig.includes('images')
      };
      
      const optimizationScore = Object.values(checks).filter(Boolean).length;
      
      return {
        optimizationScore: `${optimizationScore}/5`,
        checks,
        bundleEstimate: '< 150KB (estim√©)'
      };
    });
  }

  async testAccessibility() {
    return this.runTest("Accessibilit√©", async () => {
      const config = await ClientGenerator.generateClientConfig(testClient);
      const files = (ClientGenerator as any).generateSiteFiles(config);
      const mainPage = files['app/page.tsx'];
      
      // V√©rifier les bonnes pratiques d'accessibilit√©
      const accessibilityFeatures = {
        semanticHTML: mainPage.includes('<section'),
        altTexts: mainPage.includes('alt='),
        ariaLabels: mainPage.includes('aria-'),
        keyboardNav: mainPage.includes('onKeyDown') || mainPage.includes('tabIndex'),
        headingStructure: mainPage.includes('<h1') && mainPage.includes('<h2')
      };
      
      const accessibilityScore = Object.values(accessibilityFeatures).filter(Boolean).length;
      
      if (accessibilityScore < 3) {
        throw new Error("Score d'accessibilit√© insuffisant");
      }
      
      return {
        accessibilityScore: `${accessibilityScore}/5`,
        features: accessibilityFeatures,
        wcagCompliance: accessibilityScore >= 4 ? 'AA' : 'A'
      };
    });
  }

  async runAllTests() {
    console.log("üöÄ D√©marrage des tests d'architecture compl√®te\n");
    
    // Ex√©cuter tous les tests
    await this.testConfigGeneration();
    await this.testFileGeneration();
    await this.testTemplateRendering();
    await this.testDatabaseSchema();
    await this.testSEOGeneration();
    await this.testResponsiveComponents();
    await this.testPerformanceOptimization();
    await this.testAccessibility();
    
    // G√©n√©rer le rapport
    this.generateReport();
  }

  private generateReport() {
    console.log("\nüìä RAPPORT DE TESTS D'ARCHITECTURE");
    console.log("=" .repeat(50));
    
    const totalTests = this.results.length;
    const passedTests = this.results.filter(r => r.success).length;
    const failedTests = totalTests - passedTests;
    const totalDuration = this.results.reduce((sum, r) => sum + r.duration, 0);
    
    console.log(`\nüìà R√©sum√© global:`);
    console.log(`   ‚úÖ Tests r√©ussis: ${passedTests}/${totalTests}`);
    console.log(`   ‚ùå Tests √©chou√©s: ${failedTests}/${totalTests}`);
    console.log(`   ‚è±Ô∏è  Dur√©e totale: ${totalDuration}ms`);
    console.log(`   üìä Taux de r√©ussite: ${Math.round((passedTests/totalTests) * 100)}%`);
    
    console.log(`\nüìã D√©tail des tests:`);
    this.results.forEach((result, index) => {
      const status = result.success ? "‚úÖ" : "‚ùå";
      console.log(`   ${status} ${result.name} (${result.duration}ms)`);
      
      if (result.success && result.details) {
        // Afficher quelques d√©tails pour les tests r√©ussis
        const details = result.details;
        if (details.domain) console.log(`       ‚Üí Domaine: ${details.domain}`);
        if (details.filesGenerated) console.log(`       ‚Üí Fichiers: ${details.filesGenerated}`);
        if (details.optimizationScore) console.log(`       ‚Üí Performance: ${details.optimizationScore}`);
        if (details.accessibilityScore) console.log(`       ‚Üí Accessibilit√©: ${details.accessibilityScore}`);
      }
      
      if (!result.success && result.error) {
        console.log(`       ‚ùå ${result.error}`);
      }
    });
    
    // Recommandations
    console.log(`\nüí° Recommandations:`);
    
    if (passedTests === totalTests) {
      console.log(`   üéâ Tous les tests passent ! L'architecture est pr√™te pour la production.`);
      console.log(`   üöÄ Vous pouvez proc√©der au d√©ploiement d'un site test.`);
    } else {
      console.log(`   ‚ö†Ô∏è  ${failedTests} test(s) √† corriger avant la production.`);
      const failedTestNames = this.results.filter(r => !r.success).map(r => r.name);
      console.log(`   üîß Tests √©chou√©s: ${failedTestNames.join(', ')}`);
    }
    
    // M√©triques de qualit√©
    console.log(`\nüèÜ M√©triques de qualit√©:`);
    const qualityMetrics = this.calculateQualityMetrics();
    Object.entries(qualityMetrics).forEach(([metric, score]) => {
      const emoji = score >= 80 ? "üü¢" : score >= 60 ? "üü°" : "üî¥";
      console.log(`   ${emoji} ${metric}: ${score}%`);
    });
    
    console.log(`\n‚ú® Tests d'architecture termin√©s !`);
  }

  private calculateQualityMetrics() {
    const metrics: Record<string, number> = {};
    
    // M√©trique de g√©n√©ration
    const generationTests = ['G√©n√©ration de configuration', 'G√©n√©ration des fichiers'];
    const generationSuccess = generationTests.filter(name => 
      this.results.find(r => r.name === name)?.success
    ).length;
    metrics['G√©n√©ration'] = Math.round((generationSuccess / generationTests.length) * 100);
    
    // M√©trique de qualit√© du code
    const qualityTests = ['Composants responsive', 'Optimisations performance', 'Accessibilit√©'];
    const qualitySuccess = qualityTests.filter(name => 
      this.results.find(r => r.name === name)?.success
    ).length;
    metrics['Qualit√© Code'] = Math.round((qualitySuccess / qualityTests.length) * 100);
    
    // M√©trique SEO
    const seoTests = ['G√©n√©ration SEO'];
    const seoSuccess = seoTests.filter(name => 
      this.results.find(r => r.name === name)?.success
    ).length;
    metrics['SEO'] = Math.round((seoSuccess / seoTests.length) * 100);
    
    // Score global
    const globalSuccess = this.results.filter(r => r.success).length;
    metrics['Global'] = Math.round((globalSuccess / this.results.length) * 100);
    
    return metrics;
  }
}

// Ex√©cution des tests
async function main() {
  const testSuite = new ArchitectureTestSuite();
  
  try {
    await testSuite.runAllTests();
    process.exit(0);
  } catch (error) {
    console.error("üí• Erreur critique lors des tests:", error);
    process.exit(1);
  }
}

main();